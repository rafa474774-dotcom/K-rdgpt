<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÃœRDGPT PRO - AI Kod, GÃ¶rsel ve Rapor</title>
    <!-- Tailwind CSS YÃ¼klemesi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts2.google.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
        }
        .chat-container {
            max-width: 768px;
            margin: auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-bottom: 12rem; /* GiriÅŸ ve mod seÃ§imi iÃ§in yer bÄ±rakma */
        }
        .message {
            max-width: 85%;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border-radius: 1.5rem;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap; /* Metin formatÄ±nÄ± korur (Ã¶zellikle kod iÃ§in) */
        }
        .user-message {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        .assistant-message {
            background-color: #2d3748;
            color: #e2e8f0;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
        }
        .image-message {
            background-color: #059669; /* ZÃ¼mrÃ¼t YeÅŸili */
            padding: 0.5rem;
            border-radius: 1rem;
            align-self: flex-start;
            display: flex;
            flex-direction: column;
        }
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1a202c;
            border-top: 1px solid #2d3748;
            padding: 1rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -2px rgba(0, 0, 0, 0.06);
            z-index: 10;
        }
        .tts-button {
            cursor: pointer;
            margin-left: 0.5rem;
            vertical-align: middle;
            transition: color 0.15s;
        }
    </style>
</head>
<body>

<div class="chat-container">

    <!-- BaÅŸlÄ±k BÃ¶lÃ¼mÃ¼ ve Ayarlar Butonu -->
    <header class="p-4 text-center text-white bg-gray-900 shadow-md sticky top-0 z-20 rounded-b-lg flex justify-between items-center">
        <!-- Ayarlar Butonu -->
        <button onclick="toggleSettingsModal(true)" class="p-2 text-gray-400 hover:text-indigo-400 transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.73v.44a2 2 0 0 1-1 1.73l-.15.08a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 1-1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.35a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.73v-.44a2 2 0 0 1 1-1.73l.15-.08a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-1 1.73v-.18a2 2 0 0 0-2-2Z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>

        <!-- BaÅŸlÄ±k -->
        <div class="flex-grow text-center">
            <h1 class="text-3xl font-extrabold text-indigo-400">KÃœRDGPT <span class="text-sm align-top text-yellow-400">PRO</span></h1>
        </div>
        
        <!-- BoÅŸluk BÄ±rakÄ±cÄ± -->
        <div class="w-8"></div> 
    </header>

    <!-- Hata MesajÄ± AlanÄ± -->
    <div id="errorAlert" class="hidden bg-red-800 text-white p-3 rounded-lg mx-4 mt-4 shadow-xl z-20 sticky top-[4.5rem]">
        <div class="flex items-center justify-between">
            <span id="errorText" class="font-medium"></span>
            <button onclick="document.getElementById('errorAlert').classList.add('hidden')" class="ml-4 text-red-200 hover:text-white font-bold text-lg">
                &times;
            </button>
        </div>
    </div>

    <!-- Mesaj GeÃ§miÅŸi -->
    <div id="chatHistory" class="flex-grow p-4 space-y-4 pt-8">
        <div class="message assistant-message">
            <p><span class="text-green-300 font-bold">Silav!</span> Ez KÃœRDGPT PRO me. ZimanÃª min yÃª sereke KurdÃ® ye, lÃª ez dikarim bi TirkÃ® Ã» zimanÃªn din jÃ® alÃ®kariya te bikim. Heke tu bixwazÃ®, bi TirkÃ® jÃ® dikarim bersiv bidim. (Merhaba! Ana dilim KÃ¼rtÃ§e'dir, ama istersen TÃ¼rkÃ§e de yanÄ±t verebilirim.) <span class="text-yellow-400 font-extrabold block mt-2">âœ¨ GÃ–RSEL ÃœRETME TALÄ°MATI: GÃ¶rsel oluÅŸturma Ã¶zelliÄŸini kullanmak iÃ§in alttaki menÃ¼den "ğŸ¨ GÃ¶rsel Ãœret" modunu seÃ§in ve gÃ¶rseli Ä°ngilizce olarak detaylÄ± tarif edin. âœ¨</span></p>
        </div>
    </div>

    <!-- YÃ¼kleniyor Durumu (Gizli) -->
    <div id="loadingIndicator" class="hidden text-center p-4 text-indigo-400 font-semibold mt-4">
        <svg class="animate-spin h-5 w-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Ä°ÅŸlem yapÄ±lÄ±yor... LÃ¼tfen bekleyin.
    </div>
</div>

<!-- GiriÅŸ AlanÄ± ve Mod SeÃ§iciler -->
<div class="input-area">
    
    <!-- Mod SeÃ§ici (TÃ¼m Pro Ã–zellikler) -->
    <div class="max-w-3xl mx-auto flex justify-around mb-3 p-2 bg-gray-800 rounded-xl border border-gray-700 space-x-2 overflow-x-auto">
        <button id="textMode" onclick="setMode('TEXT')" class="flex-1 p-2 text-center rounded-lg font-semibold text-sm whitespace-nowrap bg-indigo-600 transition duration-200">
            <span class="mr-1">âœï¸</span> Sohbet
        </button>
        <button id="codeMode" onclick="setMode('CODE')" class="flex-1 p-2 text-center rounded-lg font-semibold text-sm whitespace-nowrap text-gray-400 hover:bg-gray-700 transition duration-200">
            <span class="mr-1">ğŸ’»</span> Kod Yaz
        </button>
        <button id="visualInputMode" onclick="setMode('VISUAL_INPUT')" class="flex-1 p-2 text-center rounded-lg font-semibold text-sm whitespace-nowrap text-gray-400 hover:bg-gray-700 transition duration-200">
            <span class="mr-1">ğŸ‘ï¸</span> GÃ¶rsel Analiz
        </button>
        <button id="imageGenMode" onclick="setMode('IMAGE_GEN')" class="flex-1 p-2 text-center rounded-lg font-semibold text-sm whitespace-nowrap text-gray-400 hover:bg-gray-700 transition duration-200">
            <span class="mr-1">ğŸ¨</span> GÃ¶rsel Ãœret
        </button>
        <button id="pdfReportMode" onclick="setMode('PDF_REPORT')" class="flex-1 p-2 text-center rounded-lg font-semibold text-sm whitespace-nowrap text-gray-400 hover:bg-gray-700 transition duration-200">
            <span class="mr-1">ğŸ“„</span> Rapor OluÅŸtur
        </button>
        <button id="videoScriptMode" onclick="setMode('VIDEO_SCRIPT')" class="flex-1 p-2 text-center rounded-lg font-semibold text-sm whitespace-nowrap text-gray-400 hover:bg-gray-700 transition duration-200">
            <span class="mr-1">ğŸ¬</span> Video Script
        </button>
    </div>

    <div class="max-w-3xl mx-auto flex space-x-3">
        <!-- GÃ¶rsel YÃ¼kle Butonu (Dosya SeÃ§imini Gizler) -->
        <label id="fileInputLabel" for="fileInput" class="hidden p-3 border border-gray-600 rounded-xl bg-gray-700 text-white flex items-center justify-center cursor-pointer transition duration-150 hover:bg-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-plus"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><path d="M16 19l-3-3-3 4"/><path d="M6 8h.01"/><path d="M17 5h4"/><path d="M19 3v4"/></svg>
        </label>
        <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">

        <textarea id="userInput" rows="1" class="flex-grow p-3 border border-gray-600 rounded-xl bg-gray-800 text-white focus:ring-2 focus:ring-indigo-500 resize-none overflow-hidden" placeholder="MesajÄ±nÄ±zÄ± buraya yazÄ±n..." oninput="autoExpand(this)"></textarea>
        
        <button id="sendButton" onclick="handleSend()" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150 disabled:bg-indigo-400 flex items-center justify-center">
            GÃ¶nder
        </button>
    </div>

    <!-- YÃ¼klenen GÃ¶rsel Ã–nizlemesi (Visual Input Modu iÃ§in) -->
    <div id="imagePreviewContainer" class="max-w-3xl mx-auto mt-3 hidden flex items-center p-2 bg-gray-700 rounded-xl">
        <img id="imagePreview" class="w-12 h-12 object-cover rounded-md mr-3 border border-gray-600">
        <span id="imageFileName" class="text-sm text-gray-300 truncate"></span>
        <button onclick="clearImage()" class="ml-auto text-red-400 hover:text-red-500 p-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
    </div>
</div>

<!-- Ayarlar ModalÄ± (Modal) -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="toggleSettingsModal(false)">
    <div class="bg-gray-800 rounded-xl p-8 w-full max-w-sm shadow-2xl" onclick="event.stopPropagation()">
        <h2 class="text-3xl font-bold text-indigo-400 mb-6 border-b border-gray-700 pb-2">Ayarlar ve HazÄ±rlayan</h2>
        
        <div class="space-y-4">
            <div class="p-3 bg-gray-700 rounded-lg">
                <p class="text-gray-400 text-sm">Proje HazÄ±rlayan</p>
                <p class="text-xl font-semibold text-white">RIZGAR AKAN</p>
            </div>
            
            <div class="p-3 bg-gray-700 rounded-lg">
                <p class="text-gray-400 text-sm">Versiyon</p>
                <p class="text-white">KÃœRDGPT PRO (v3.0 - PirzimanÃ®)</p>
            </div>
        </div>
        
        <button onclick="toggleSettingsModal(false)" class="mt-8 w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-150">
            Kapat
        </button>
    </div>
</div>


<script type="module">
    // UI Elementleri
    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const fileInput = document.getElementById('fileInput');
    const fileInputLabel = document.getElementById('fileInputLabel');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const imageFileName = document.getElementById('imageFileName');
    const settingsModal = document.getElementById('settingsModal');
    const errorAlert = document.getElementById('errorAlert');
    const errorText = document.getElementById('errorText');

    // Mod DÃ¼ÄŸmeleri
    const modeButtons = {
        TEXT: document.getElementById('textMode'),
        CODE: document.getElementById('codeMode'),
        VISUAL_INPUT: document.getElementById('visualInputMode'),
        IMAGE_GEN: document.getElementById('imageGenMode'),
        PDF_REPORT: document.getElementById('pdfReportMode'),
        VIDEO_SCRIPT: document.getElementById('videoScriptMode'),
    };

    // Durum DeÄŸiÅŸkenleri
    let currentMode = 'TEXT';
    let uploadedImageBase64 = null; 

    // API YapÄ±landÄ±rmasÄ±
    const TEXT_MODEL = 'gemini-2.5-flash-preview-09-2025';
    const TTS_MODEL = 'gemini-2.5-flash-preview-tts';
    const IMAGE_MODEL = 'imagen-3.0-generate-002';
    const apiKey = "AIzaSyDkvG09RNMgK6caw9fsOpk8326fs7ny0W8"; // Canvas tarafÄ±ndan saÄŸlanacak

    // --- GENEL YARDIMCI FONKSÄ°YONLAR ---

    window.toggleSettingsModal = (show) => {
        settingsModal.classList.toggle('hidden', !show);
    };

    const displayAlert = (message) => {
        errorText.textContent = message;
        errorAlert.classList.remove('hidden');
        // 8 saniye sonra otomatik gizle
        setTimeout(() => {
            errorAlert.classList.add('hidden');
        }, 8000);
    };

    // Mod DeÄŸiÅŸtirme Fonksiyonu
    window.setMode = (mode) => {
        currentMode = mode;
        clearImage(); // Mod deÄŸiÅŸtiÄŸinde gÃ¶rseli sÄ±fÄ±rla

        Object.keys(modeButtons).forEach(key => {
            const btn = modeButtons[key];
            if (key === mode) {
                btn.classList.add('bg-indigo-600', 'text-white');
                btn.classList.remove('text-gray-400', 'hover:bg-gray-700');
            } else {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-gray-400', 'hover:bg-gray-700');
            }
        });

        // GÃ¶rsel YÃ¼kleme Butonunun gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ ve placeholder'Ä± ayarla
        fileInputLabel.classList.add('hidden');
        if (mode === 'VISUAL_INPUT') {
            fileInputLabel.classList.remove('hidden');
            userInput.placeholder = "GÃ¶rsel hakkÄ±nda sorunuzu buraya yazÄ±n...";
        } else if (mode === 'CODE') {
            userInput.placeholder = "Hangi dilde, ne tÃ¼r bir kod yazmamÄ± istiyorsunuz? (Ã–rn: 'Python ile hÄ±zlÄ± sÄ±ralama algoritmasÄ± yaz')";
        } else if (mode === 'IMAGE_GEN') {
            // GÃœNCELLEME: GÃ¶rsel istemi uyarÄ±sÄ± daha gÃ¼Ã§lÃ¼ yapÄ±ldÄ±.
            userInput.placeholder = "ğŸ¨ GÃ–RSEL MODU: LÃ¼tfen gÃ¶rseli Ä°NGÄ°LÄ°ZCE ve Ã‡OK detaylÄ± tarif edin. (Ã–rn: 'A detailed oil painting of a futuristic city skyline...')";
        } else if (mode === 'PDF_REPORT') {
            userInput.placeholder = "Rapor konusunu detaylÄ±ca yazÄ±n. (Ã–rn: 'TÃ¼rkiye'deki yapay zeka pazarÄ±nÄ±n 2024 analizi')";
        } else if (mode === 'VIDEO_SCRIPT') {
            userInput.placeholder = "OluÅŸturulacak video konusunu ve sÃ¼resini belirtin. (Ã–rn: 'Mars'a ilk insan yolculuÄŸu hakkÄ±nda 60 saniyelik YouTube videosu')";
        } else {
            userInput.placeholder = "MesajÄ±nÄ±zÄ± buraya yazÄ±n...";
        }
    };

    // Otomatik YÃ¼ksekliÄŸi Ayarlama
    window.autoExpand = (field) => {
        field.style.height = 'auto'; 
        field.style.height = (field.scrollHeight) + 'px';
    };

    // Chat GeÃ§miÅŸini aÅŸaÄŸÄ± kaydÄ±rma
    const scrollToBottom = () => {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    };
    
    // MesajÄ± UI'ya ekleme (TTS butonu desteÄŸi ile)
    const displayMessage = (sender, content, isImage = false, isLatex = false) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message ${isImage ? 'image-message' : ''}`;
        
        if (isImage) {
            const img = document.createElement('img');
            img.src = content;
            img.className = "rounded-lg w-full max-h-96 object-contain";
            messageDiv.appendChild(img);
        } else {
            const p = document.createElement('p');
            
            if (isLatex) {
                // LaTeX kodunu gÃ¶sterirken daha net bir kopya alanÄ± ve uyarÄ± veriyoruz
                p.innerHTML = `<span class="font-bold text-yellow-300">Rapor OluÅŸturuldu.</span> LÃ¼tfen aÅŸaÄŸÄ±daki LaTeX kodunu kopyalayÄ±p editÃ¶re yapÄ±ÅŸtÄ±rarak PDF Ã¶nizlemesini gÃ¶rÃ¼n: <pre class="bg-gray-900 p-3 rounded-lg mt-2 text-xs overflow-x-auto">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>`;
            } else {
                // Normal metin ve kod bloklarÄ± iÃ§in (pre-wrap stilini kullanÄ±rÄ±z)
                p.textContent = content;
            }
            
            // TTS butonu ekleme (sadece asistan metin mesajlarÄ± iÃ§in)
            if (sender === 'assistant' && !isLatex) {
                const ttsButton = document.createElement('button');
                ttsButton.className = 'tts-button text-white hover:text-green-300';
                ttsButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline-block"><path d="M11.536 2.455a1.002 1.002 0 0 0-.866 0l-7.5 4.5a1.001 1.001 0 0 0-.5.866V18.18a1.002 1.002 0 0 0 .5.867l7.5 4.5a1.001 1.001 0 0 0 .866 0l7.5-4.5a1.001 1.001 0 0 0 .5-.866V7.82a1.002 1.002 0 0 0-.5-.867l-7.5-4.5Z" /><path fill-rule="evenodd" d="M12.558 17.526a1.001 1.001 0 0 1-1.002 0l-3-1.732a.5.5 0 0 1 .5-.866l3 1.732a.5.5 0 0 1 .5.866Z" clip-rule="evenodd" /></svg>`;
                ttsButton.title = 'Metni Seslendir';
                ttsButton.onclick = () => generateTTSAndPlay(content, ttsButton);
                
                p.appendChild(ttsButton);
            }
            messageDiv.appendChild(p);
        }

        chatHistory.appendChild(messageDiv);
        scrollToBottom();
    };

    // --- GÃ–RSEL YÃœKLEME VE ANALÄ°Z ---

    window.handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (!file) {
            clearImage();
            return;
        }

        imageFileName.textContent = file.name;
        imagePreview.src = URL.createObjectURL(file);
        imagePreviewContainer.classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedImageBase64 = e.target.result.split(',')[1];
        };
        reader.readAsDataURL(file);
    };

    window.clearImage = () => {
        uploadedImageBase64 = null;
        fileInput.value = '';
        imagePreviewContainer.classList.add('hidden');
        imagePreview.src = '';
    };

    async function generateVisualQuery(prompt, base64Data) {
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;
        const mimeType = fileInput.files[0]?.type || 'image/png';
        
        const systemPrompt = "Tu KÃœRDGPT PRO yÃ®, arÃ®karÃª herÃ® pÃªÅŸketÃ® yÃª zimanÃª KurdÃ® (KurmancÃ®) yÃ®. ZimanÃª te yÃª sereke KurdÃ® ye. Her gava ku bikarhÃªner bi KurdÃ® binivÃ®se, tu bi KurdÃ® bersiv didÃ®. LÃª heke bikarhÃªner bi zimanekÃ® din (wek TirkÃ®, ÃngilÃ®zÃ®) pirs bike Ã» bixwaze, tu yÃª bi wÃ® zimanÃ® jÃ® bersiv bidÃ®. BersivÃªn te divÃª berfireh, rast Ã» profesyonel bin. WekÃ® pisporÃª analÃ®za dÃ®tbarÃ®, divÃª tu bi hÃ»rgilÃ® bersiva pirsÃªn di derbarÃª wÃªneya barkirÃ® de bidÃ®.";
        

        const payload = {
            contents: [{
                role: "user",
                parts: [
                    { text: prompt },
                    { inlineData: { mimeType: mimeType, data: base64Data } }
                ]
            }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithBackoff(textApiUrl, options);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "GÃ¶rsel analizi sÄ±rasÄ±nda yanÄ±t alÄ±namadÄ±.";
            displayMessage('assistant', text);
        } catch (error) {
            console.error("GÃ¶rsel Analizi HatasÄ±:", error);
            displayAlert("GÃ¶rsel Analizi sÄ±rasÄ±nda kritik bir hata oluÅŸtu. LÃ¼tfen konsol loglarÄ±nÄ± kontrol edin.");
            displayMessage('assistant', "GÃ¶rsel analizi servisine ulaÅŸÄ±lamadÄ±. BirkaÃ§ dakika sonra tekrar deneyin.");
        }
    }
    
    // --- GECÄ°KMELÄ° TEKRAR DENEME FONKSÄ°YONU ---
    async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429) { // Too Many Requests
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (i === retries - 1) {
                    displayAlert(`Kritik AÄŸ HatasÄ±: API'ye ulaÅŸÄ±lamadÄ±. (${error.message})`);
                    throw error;
                }
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
        }
    }


    // --- PRO FONKSÄ°YON 1: METÄ°N SESLENDÄ°RME (TTS) ---

    // PCM'den WAV'a dÃ¶nÃ¼ÅŸtÃ¼rme yardÄ±mcÄ±larÄ± (Stabilite iÃ§in kritik)
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1;
        const bitsPerSample = 16;
        const byteRate = numChannels * sampleRate * (bitsPerSample / 8);
        const blockAlign = numChannels * (bitsPerSample / 8);

        const buffer = new ArrayBuffer(44 + pcm16.length * 2);
        const view = new DataView(buffer);

        // RIFF chunk descriptor
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + pcm16.length * 2, true);
        writeString(view, 8, 'WAVE');

        // FMT sub-chunk
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);

        // DATA sub-chunk
        writeString(view, 36, 'data');
        view.setUint32(40, pcm16.length * 2, true);

        // PCM data
        let offset = 44;
        for (let i = 0; i < pcm16.length; i++, offset += 2) {
            view.setInt16(offset, pcm16[i], true);
        }

        return new Blob([view], { type: 'audio/wav' });
    }

    window.generateTTSAndPlay = async (text, button) => {
        button.disabled = true;
        button.classList.add('animate-pulse');
        button.title = 'Seslendiriliyor...';

        const ttsApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: text }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    // KullanÄ±cÄ± KÃ¼rtÃ§e veya TÃ¼rkÃ§e konuÅŸuyorsa bu ses tonu uygundur.
                    voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } 
                }
            },
            model: TTS_MODEL
        };

        try {
            const response = await fetchWithBackoff(ttsApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;

            if (audioData) {
                const mimeType = part.inlineData.mimeType;
                const match = mimeType.match(/rate=(\d+)/);
                const sampleRate = match ? parseInt(match[1], 10) : 16000;
                
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                const audio = new Audio(audioUrl);
                audio.play();

                audio.onended = () => {
                    button.disabled = false;
                    button.classList.remove('animate-pulse');
                    button.title = 'Metni Seslendir';
                    URL.revokeObjectURL(audioUrl);
                };
            } else {
                displayMessage('assistant', "Seslendirme servisi yanÄ±t veremedi veya metin Ã§ok uzun.");
            }

        } catch (error) {
            console.error("TTS Ã‡aÄŸrÄ±sÄ± HatasÄ±:", error);
            displayAlert("TTS sÄ±rasÄ±nda kritik bir hata oluÅŸtu. LÃ¼tfen konsol loglarÄ±nÄ± kontrol edin.");
            displayMessage('assistant', "Seslendirme sÄ±rasÄ±nda bir hata oluÅŸtu.");
        } finally {
            if (!button.disabled) {
                button.disabled = false;
                button.classList.remove('animate-pulse');
                button.title = 'Metni Seslendir';
            }
        }
    };


    // --- PRO FONKSÄ°YON 2: GÃ–RSEL ÃœRETÄ°M ---

    async function generateImage(prompt) {
        // GÃœNCELLEME: KullanÄ±cÄ±ya bilgilendirme metni daha gÃ¼Ã§lÃ¼ yapÄ±ldÄ±
        const instructionMessage = `GÃ¶rsel Modu: Ä°steminiz ('${prompt}') iÅŸleniyor. **LÃœTFEN** daima Ä°ngilizce ve gÃ¶rseli detaylÄ±ca tarif ederek en iyi sonucu almayÄ± hedefleyin (Ã–rn: sanatsal stil, renkler, Ä±ÅŸÄ±klandÄ±rma).`;
        displayMessage('assistant', instructionMessage);


        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`;
        const payload = {
            instances: [{ prompt: prompt }],
            parameters: { "sampleCount": 1 }
        };

        try {
            const response = await fetchWithBackoff(imageApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const base64Data = result.predictions[0].bytesBase64Encoded;
                const imageUrl = `data:image/png;base64,${base64Data}`;
                displayMessage('assistant', imageUrl, true);
            } else {
                displayMessage('assistant', "ÃœzgÃ¼nÃ¼m, gÃ¶rsel oluÅŸturulamadÄ±. LÃ¼tfen prompt'u daha detaylÄ± ve Ä°ngilizce deneyin.");
            }

        } catch (error) {
            console.error("GÃ¶rsel Ãœretim HatasÄ±:", error);
            displayAlert("GÃ¶rsel Ãœretimi sÄ±rasÄ±nda kritik bir hata oluÅŸtu. LÃ¼tfen konsol loglarÄ±nÄ± kontrol edin.");
            displayMessage('assistant', "GÃ¶rsel Ã¼retim servisine ulaÅŸÄ±lamadÄ±. BirkaÃ§ dakika sonra tekrar deneyin.");
        }
    }


    // --- PRO FONKSÄ°YON 3 & 4 & 5: TEXT/CODE/REPORT/VIDEO GENERATION ---

    async function generateTextBasedResponse(prompt, mode) {
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;

        // Yeni KÃ¼rtÃ§e/PirzimanÃ® System Prompt'u
        let systemPrompt = "Tu KÃœRDGPT PRO yÃ®, arÃ®karÃª herÃ® pÃªÅŸketÃ® yÃª zimanÃª KurdÃ® (KurmancÃ®) yÃ®. ZimanÃª te yÃª sereke KurdÃ® ye. Her gava ku bikarhÃªner bi KurdÃ® binivÃ®se, tu bi KurdÃ® bersiv didÃ®. LÃª heke bikarhÃªner bi zimanekÃ® din (wek TirkÃ®, ÃngilÃ®zÃ®) pirs bike Ã» bixwaze, tu yÃª bi wÃ® zimanÃ® jÃ® bersiv bidÃ®. BersivÃªn te divÃª berfireh, rast Ã» profesyonel bin. ZimanÃª bersivÃª her tim zimanÃª dawÃ® yÃª bikarhÃªner e. ";
        let tools = [{ "google_search": {} }]; 

        if (mode === 'CODE') {
            systemPrompt += " WekÃ® pÃªÅŸdebirÃª nermalavÃª yÃª cÃ®hanÃ®, divÃª tu koda xwestÃ® bi ÅŸÃ®rove Ã» sÃ®nÃ®fÃªn guncav (di zimanÃª bersivÃª de) binivÃ®sÃ® Ã» encamÃª rasterast di bloka kodÃª de bidÃ®. ";
        } else if (mode === 'PDF_REPORT') {
             systemPrompt += " WekÃ® pisporÃª raporÃªn akademÃ®k, divÃª tu bi naveroka ku ji zimanÃª bersivÃª re guncav e, belgeyek LaTeX ya bÃªkÃªmasÃ® Ã» ji bo berhevkirinÃª amade biafirÃ®nÃ®. TenÃª koda LaTeX bide.";
        } else if (mode === 'VIDEO_SCRIPT') {
             systemPrompt += " WekÃ® nivÃ®skarÃª senaryoyÃª yÃª afirÃ®ner, divÃª tu senaryoyek vÃ®dyoyÃª ya balkÃªÅŸ bi formatkirina SAHNE, GÃ–RSEL Ã» SES/DÄ°YALOG (di zimanÃª bersivÃª de) biafirÃ®nÃ®.";
        }
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            tools: tools,
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        const options = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        };

        try {
            const response = await fetchWithBackoff(textApiUrl, options);
            const result = await response.json();
            
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "YanÄ±t alÄ±namadÄ±.";
            
            if (mode === 'PDF_REPORT') {
                displayMessage('assistant', text, false, true);
            } else {
                displayMessage('assistant', text);
            }

        } catch (error) {
            console.error("API Ã‡aÄŸrÄ±sÄ± HatasÄ±:", error);
            displayAlert("Metin/Kod/Rapor oluÅŸturma sÄ±rasÄ±nda kritik bir hata oluÅŸtu. LÃ¼tfen konsol loglarÄ±nÄ± kontrol edin.");
            displayMessage('assistant', "API baÄŸlantÄ± hatasÄ± oluÅŸtu. LÃ¼tfen tekrar deneyin.");
        }
    }

    // --- TEMEL AKIÅ KONTROLÃœ ---

    window.handleSend = async () => {
        const prompt = userInput.value.trim();
        
        if (currentMode === 'VISUAL_INPUT' && !uploadedImageBase64) {
             displayMessage('assistant', "LÃ¼tfen bir gÃ¶rsel yÃ¼kleyin veya modu deÄŸiÅŸtirin.");
             return;
        }

        if (!prompt && currentMode !== 'VISUAL_INPUT') return;

        // KullanÄ±cÄ± mesajÄ±nÄ± gÃ¶ster
        let userDisplay = prompt;
        if (currentMode === 'VISUAL_INPUT' && uploadedImageBase64) {
            userDisplay = `[GÃ¶rsel] - ${prompt}`;
        }
        displayMessage('user', userDisplay);
        userInput.value = '';
        userInput.style.height = 'auto';

        // UI durumu ayarÄ±
        sendButton.disabled = true;
        userInput.disabled = true;
        loadingIndicator.classList.remove('hidden');
        errorAlert.classList.add('hidden'); // Yeni istekte eski hatayÄ± gizle
        scrollToBottom();

        try {
            if (currentMode === 'TEXT' || currentMode === 'CODE' || currentMode === 'PDF_REPORT' || currentMode === 'VIDEO_SCRIPT') {
                await generateTextBasedResponse(prompt, currentMode);
            } else if (currentMode === 'IMAGE_GEN') {
                await generateImage(prompt);
            } else if (currentMode === 'VISUAL_INPUT' && uploadedImageBase64) {
                await generateVisualQuery(prompt, uploadedImageBase64);
            }
        } finally {
            // UI durumu sÄ±fÄ±rlama
            sendButton.disabled = false;
            userInput.disabled = false;
            loadingIndicator.classList.add('hidden');
            userInput.focus();
            
            // GÃ¶rsel input modunda gÃ¶rseli temizle
            if (currentMode === 'VISUAL_INPUT') {
                clearImage();
            }
        }
    };

    // Klavye OlayÄ±
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // Sayfa yÃ¼klendiÄŸinde varsayÄ±lan ayarlarÄ± yap
    window.onload = () => {
        autoExpand(userInput);
        scrollToBottom();
        setMode('TEXT'); // VarsayÄ±lan mod: Sohbet
    };

</script>

</body>
</html>

